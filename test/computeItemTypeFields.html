<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
  xml:lang="en" lang="en">
<head>
<title>Zotero XML Importer - compute item type fields</title>
<style type="text/css">
<!--
body { 
  color: #006600;
  background-color: #ffffff;
  font-family: Verdana,Geneva,Arial,sans-serif;
  margin: 1em;
  border: 0;
  padding: 0;
  font-size: 80%;
}
h1, p { 
  margin: 0;
}
table {
  border-collapse: collapse;
}
#Result { 
  padding: 1em;
  margin: 0;
}
-->
</style>
  <script type="text/javascript">
    function _ParseEntity(lines, name) 
    {
      var RE = new RegExp("INSERT\\s+INTO\\s+" + name + "\\s+VALUES\\s*\\(\\s*(\\d+)\\s*,\\s*['\"](\\w+)[\"']", "g");
      var result;
      var Obj = {};
      while ( (result = RE.exec(lines)) != null) {
        Obj[result[1]] = result[2];
      }
      return Obj;
    }

    function _ParseRelation(lines, name) 
    {
      var RE = new RegExp("INSERT\\s+INTO\\s+" + name + "\\s+VALUES\\s*\\(\\s*(\\d+)\\s*,\\s*(\\d+)", "g");
      var result;
      var Obj = {};
      while ( (result = RE.exec(lines)) != null) {
        if (!Obj[result[1]]) {
          Obj[result[1]] = [];
        }
        Obj[result[1]].push(result[2]);
      }
      return Obj;
    }

    function Compute()
    {
      var lines = document.getElementById("sql").value;
      // 207	INSERT INTO itemTypes VALUES (1,'note',NULL,0);

      var ItemTypes = _ParseEntity(lines, "itemTypes");
      var Fields    = _ParseEntity(lines, "fields");
      var ItemTypeFields = _ParseRelation(lines, "itemTypeFields");
      var s = "<html><body>";
      var ItemTypeNumbers = [];
      var ItemTypeNames = [];
      for (var itemType in ItemTypes) {
        ItemTypeNames.push(ItemTypes[itemType]);
        ItemTypeNumbers.push(itemType);
      }
      ItemTypeNames.sort();
      s += "<p>\n";
      for (var it = 0; it < ItemTypeNames.length; ++it) {
        var itemTypeNumber = ItemTypeNumbers[it];
        var itemType       = ItemTypeNames[it];
        s += "<a href='#" + itemType + "'>" + itemType + "</a><br/>\n";
      }
      s += "</p>\n";

      for (var it = 0; it < ItemTypeNames.length; ++it) {
        var itemTypeNumber = ItemTypeNumbers[it];
        var itemType       = ItemTypeNames[it];
        s += "<h1 id='" + itemType + "' name='" + itemType + "'" + " title='itemTypeID=" + itemTypeNumber + "'>" + itemType + "</h1>\n<p>";
        var FieldNumbers = ItemTypeFields[itemTypeNumber];
        if (!FieldNumbers) { continue; }
        var F = [];
        for (var i = 0; i < FieldNumbers.length; ++i) {
          var fieldNumber = FieldNumbers[i];
          var fieldName = Fields[fieldNumber];
          // destroys sort(): F.push("<span title='fieldID=" + fieldNumber + "'>" + fieldName + "</span>");
          F.push(fieldName);
        }
        F.sort();
        s += F.join("<br/>\n") + "</p>";
      }
      var Result = document.getElementById("Result");
      Result.innerHTML = s;
    }  
  </script>

</head>
<body>
<h1>Zotero XML Importer - compute item type fields</h1>

<p>This page accepts a list of SQL statements e.g. from
<a target='_top' href='https://www.zotero.org/trac/browser/extension/branches/2.0/system.sql'>https://www.zotero.org/trac/browser/extension/branches/2.0/system.sql</a> and computes an HTML table which lists for each zotero <strong>field</strong> the allowed <strong>item types</strong>.</p>
<p>Please include the INSERT statements for the following tables (= sections of the file):</p>
<pre>
INSERT INTO itemTypes VALUES (1,'note',NULL,0);
...
INSERT INTO fields VALUES (1,'url',NULL);
...
INSERT INTO itemTypeFields VALUES (2, 110, NULL, 1);
</pre>

<textarea id="sql" name="sql" type="text" cols='80' rows='30'>
Paste SQL statements here</textarea>
<input type="button" value="Compute table"  onclick="Compute('')"/>
<hr/>
  <p>Result:</p>
  <p id="Result">...</p>
<hr />
</body>
</html>
